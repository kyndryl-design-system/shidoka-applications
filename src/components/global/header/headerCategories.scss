@use '../../../common/scss/global.scss';

// Layout configuration
$column-gap: 32px;
$row-gap: 24px;
$min-wrapper-width: 450px;
$min-column-width: 150px;
$max-column-width: 400px;

// Fixed column widths for consistency (based on column count)
// These provide predictable flyout widths regardless of content length
$column-width-1: 350px; // Single column flyout
$column-width-2: 300px; // Two column flyout (per column)
$column-width-3: 280px; // Three+ column flyout (per column)

:host {
  display: block;
  box-sizing: border-box;
  width: 100%;
}

// Desktop sizing (masonry default)
@media (min-width: 672px) {
  :host {
    padding-right: 10%;
    width: calc(100vw - 230px);
    max-width: calc(100vw - 230px);
  }
}

.header-categories {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;

  &__inner {
    display: block;
    column-width: 160px;
    column-gap: 32px;
    max-width: 100%;
    box-sizing: border-box;
  }

  &__back-slot {
    display: block;
    margin-top: 16px;
  }
}

.header-categories__inner > * {
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
  margin: 0 0 $row-gap;
}

slot.header-categories__slot::slotted(*) {
  display: block;
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
  margin: 0 0 $row-gap;
}

// Compensate for the last item's trailing bottom margin in column-based
// layouts. Grid is excluded (it resets item margin to 0 and uses gap instead).
:host(:not([layout='grid']):not([view='detail'])) .header-categories__inner {
  margin-bottom: -$row-gap;
}

/* ---------------------------------------------------------------------
   ROOT VIEW (MASONRY - default)
   ------------------------------------------------------------------ */
:host(:not([view='detail'])) .header-categories__inner {
  column-width: 160px;
}

@media (min-width: 896px) {
  :host(:not([view='detail'])) .header-categories__inner {
    column-width: 180px;
  }
}

@media (min-width: 1152px) {
  :host(:not([view='detail'])) .header-categories__inner {
    column-width: 200px;
  }
}

/* ---------------------------------------------------------------------
   MASONRY LAYOUT (opt-in via layout="masonry")
   Uses CSS column-count for true masonry behavior where items flow
   vertically in each column before moving to the next column.
   Column count is controlled via data-columns attribute.
   ------------------------------------------------------------------ */
:host([layout='masonry']) {
  width: max-content; // Shrink-fit to actual content width
  min-width: $min-column-width;
  max-width: 100%; // Don't exceed parent
}

@media (min-width: 672px) {
  :host([layout='masonry']) {
    padding-right: 16px; // Room to breathe on right edge
  }
}

// Base masonry setup - override default column-width with column-count
:host([layout='masonry']) .header-categories__inner {
  column-width: auto; // Disable auto column-width
  column-gap: $column-gap;

  // Make category dividers layout-free (absolute positioned) so they don't
  // affect column height balancing. Divider sits centered in the 16px item gap.
  --kyn-header-divider-position: absolute;
  --kyn-header-divider-bottom: -9px;
  --kyn-header-divider-left: 8px;
  --kyn-header-divider-right: 8px;
  --kyn-header-divider-margin: 0;
}

// Fixed column-count based on data-columns attribute.
// 1-2 columns use fixed column-width for consistent flyout sizing.
// 3+ columns omit column-width so column-count is honored — otherwise
// the min-width constraint silently reduces the visible column count
// when the container isn't wide enough (e.g. 5 × 280px = 1400px).
:host([layout='masonry'][data-columns='1']) .header-categories__inner {
  column-count: 1;
  column-width: $column-width-1;
}
:host([layout='masonry'][data-columns='2']) .header-categories__inner {
  column-count: 2;
  column-width: $column-width-2;
}
@for $i from 3 through 10 {
  :host([layout='masonry'][data-columns='#{$i}']) .header-categories__inner {
    column-count: $i;
  }
}

// Masonry items keep break-inside: avoid (default behavior)
// No need to reset since that's the default

/* ---------------------------------------------------------------------
   GRID LAYOUT (opt-in via layout="grid")
   Uses fixed column count from data-columns attribute to avoid
   circular dependency between container width and auto-fit.
   Items flow row-by-row (left to right, then wrap).
   ------------------------------------------------------------------ */
:host([layout='grid']) {
  width: max-content; // Shrink-fit to actual grid width
  min-width: $min-column-width;
  max-width: 100%; // Don't exceed parent
}

@media (min-width: 672px) {
  :host([layout='grid']) {
    padding-right: 16px; // Room to breathe on right edge
  }
}

// Base grid setup
:host([layout='grid']) .header-categories__inner {
  display: grid;
  gap: $row-gap $column-gap;
  // Default: single column with max width for truncation (fallback)
  grid-template-columns: minmax($min-column-width, $max-column-width);
}

// Fixed column templates based on data-columns attribute.
// 1-2 columns use fixed widths for consistent flyout sizing.
// 3+ columns use 1fr so they share available width equally — fixed widths
// (e.g. repeat(5, 280px) = 1400px) would overflow the container.
:host([layout='grid'][data-columns='1']) .header-categories__inner {
  grid-template-columns: $column-width-1;
}
:host([layout='grid'][data-columns='2']) .header-categories__inner {
  grid-template-columns: repeat(2, $column-width-2);
}
@for $i from 3 through 10 {
  :host([layout='grid'][data-columns='#{$i}']) .header-categories__inner {
    grid-template-columns: repeat($i, 1fr);
  }
}

// Grid items: reset masonry-specific styles
:host([layout='grid']) .header-categories__inner > * {
  break-inside: auto;
  -webkit-column-break-inside: auto;
  page-break-inside: auto;
  margin: 0;
  min-width: 0; // Allow grid items to shrink for text truncation
}

/* ---------------------------------------------------------------------
   DETAIL VIEW
   ------------------------------------------------------------------ */

:host([view='detail']) {
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; // Firefox
  &::-webkit-scrollbar {
    display: none; // Safari, Chrome
  }
  .header-categories {
    &__inner {
      overflow: visible;
    }
  }
}

:host([view='detail']) .header-detail-columns {
  display: flex;
  align-items: flex-start;
  gap: 0 $column-gap;
  width: max-content;
  box-sizing: border-box;
}

:host([view='detail']) .header-detail-columns > div {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 0 0 200px;
}

:host([view='detail']) .header-detail-columns--single {
  max-width: 360px;
  width: auto;
}

:host([view='detail']) .header-detail-columns kyn-header-link {
  width: 100%;
  min-width: 0;
}

@media (min-width: 42rem) {
  :host([view='detail']) .header-detail-columns > div {
    min-width: 160px;
  }
}
